name: Cleanup Old Pre-releases

on:
  schedule:
    - cron: "0 0 * * *" # Run daily at midnight UTC
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write # Needed to delete releases

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete old pre-releases
        env:
          # Provide auth and explicit repo context so gh doesn't need a .git directory
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          # Get all releases
          releases=$(gh release list --limit 1000 --repo "$GH_REPO")
          current_time=$(date +%s)
          month_ago=$(date -d "30 days ago" +%s)

          echo "Checking releases for cleanup..."

          while IFS=$'\t' read -r title type tag published_at; do
            # Skip empty lines or header
            if [[ -z "$tag" || "$tag" == "TAG NAME" ]]; then
              continue
            fi

            # Convert release date to timestamp (handle potential errors)
            if ! release_time=$(date -d "$published_at" +%s 2>/dev/null); then
              echo "Warning: Could not parse date for release $tag: $published_at"
              continue
            fi

            # Check if it's a pre-release (Draft or Pre-release)
            if [[ "$type" == "Pre-release" ]] && [[ $release_time -lt $month_ago ]]; then
              echo "Deleting old pre-release: $title ($tag) from $published_at"
              gh release delete "$tag" --yes --repo "$GH_REPO" || echo "Failed to delete release $tag"
            fi
          done <<< "$releases"

          echo "Cleanup completed"
